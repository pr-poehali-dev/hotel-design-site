# Настройка автоматической архивации отчётов

## Что это?

Каждое 1-е число месяца в 03:00 по московскому времени автоматически запускается архивация отчётов за прошлый месяц для всех апартаментов.

## ⚠️ Шаг 0: Настройка секретов (обязательно!)

Функция `cron-archive` требует доступ к базе данных. Настройте переменные окружения:

1. Откройте [poehali.dev](https://poehali.dev) → **Секреты проекта**
2. Скопируйте значение `DATABASE_URL`
3. Откройте [Yandex Cloud Console](https://console.cloud.yandex.ru/)
4. Перейдите в **Cloud Functions** → найдите функцию `cron-archive`
5. Нажмите **Редактировать**
6. В разделе **Переменные окружения** добавьте:
   - Ключ: `DATABASE_URL`
   - Значение: вставьте скопированное значение
7. Нажмите **Создать версию**

## Как настроить автозапуск?

### Способ 1: Через Yandex Cloud Functions (рекомендуется)

1. Откройте [Yandex Cloud Console](https://console.cloud.yandex.ru/)
2. Перейдите в раздел **Cloud Functions** → **Triggers**
3. Нажмите **Создать триггер**
4. Выберите тип: **Timer**
5. Настройте расписание:
   - **Cron-выражение**: `0 3 1 * *`
   - **Часовой пояс**: Europe/Moscow
6. В разделе **Функция** выберите: `cron-archive`
7. Нажмите **Создать**

### Способ 2: Внешний cron-сервис

Используйте сервис типа [cron-job.org](https://cron-job.org) или [EasyCron](https://www.easycron.com):

1. Зарегистрируйтесь в сервисе
2. Создайте новую задачу
3. URL: `https://functions.poehali.dev/86a95679-b4d6-4861-a71e-c7e9b4a7c8f0`
4. Метод: POST
5. Расписание: **0 3 1 * *** (каждое 1-е число в 03:00)
6. Часовой пояс: Europe/Moscow

### Способ 3: Вручную

Вы можете запускать архивацию вручную через кнопку **"Архивировать прошлый месяц"** в админ-панели на странице отчётов.

## Как проверить?

1. Откройте личный кабинет собственника
2. В выпадающем списке месяцев должны появляться заархивированные периоды
3. При выборе архивного месяца отображаются сохранённые данные

## Формат cron-выражения

```
0 3 1 * *
│ │ │ │ │
│ │ │ │ └─── день недели (0-6, где 0 = воскресенье)
│ │ │ └───── месяц (1-12)
│ │ └─────── день месяца (1-31)
│ └───────── час (0-23)
└─────────── минута (0-59)
```

**0 3 1 * *** означает: каждое 1-е число любого месяца в 03:00

## URL функции

```
https://functions.poehali.dev/86a95679-b4d6-4861-a71e-c7e9b4a7c8f0
```

## Что происходит при запуске?

1. Функция определяет предыдущий месяц
2. Для каждого апартамента:
   - Проверяет, не создан ли уже архив
   - Собирает все бронирования за этот месяц
   - Подсчитывает итоговые суммы
   - Сохраняет в таблицу `monthly_reports`
3. Возвращает результат: сколько отчётов заархивировано