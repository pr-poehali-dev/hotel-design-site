# Инструкция по работе с архивацией отчётов

## Для администратора

### Ручная архивация (рекомендуется в первый раз)

1. Зайдите в админ-панель → **Отчёты**
2. Нажмите кнопку **"Архивировать прошлый месяц"**
3. Подтвердите действие в диалоговом окне
4. Дождитесь сообщения об успешной архивации

**Что происходит:**
- Автоматически архивируются отчёты за прошлый месяц для ВСЕХ апартаментов
- Данные сохраняются в таблицу `monthly_reports`
- Собственники смогут видеть эти отчёты в своём личном кабинете

### Автоматическая архивация (опционально)

Для настройки автоматического запуска 1-го числа каждого месяца см. файл [CRON_SETUP.md](./CRON_SETUP.md)

## Для собственников

### Как посмотреть отчёты

1. Войдите в личный кабинет собственника
2. В правом верхнем углу есть выпадающий список месяцев
3. Выберите нужный месяц:
   - **Текущий месяц** - показывает актуальные данные
   - **Прошлые месяцы** - показывают заархивированные данные

### Что видно в отчётах

- Список всех бронирований за месяц
- Даты заезда и выезда
- Сумма бронирования
- Операционные расходы
- **Итоговая сумма к получению** за месяц

## Технические детали

### Структура базы данных

**Таблица: monthly_reports**
- `id` - уникальный идентификатор
- `apartment_id` - номер апартамента
- `month` - месяц в формате YYYY-MM
- `report_data` - JSON с данными всех бронирований
- `total_amount` - общая сумма бронирований
- `owner_funds` - сумма к получению собственником
- `operating_expenses` - операционные расходы
- `created_at` - дата создания архива

### Backend функции

1. **archive-monthly-reports** (ручная)
   - URL: проверьте в `func2url.json`
   - Используется кнопкой в админ-панели
   - Архивирует ВСЕ апартаменты за прошлый месяц

2. **cron-archive** (автоматическая)
   - URL: https://functions.poehali.dev/86a95679-b4d6-4861-a71e-c7e9b4a7c8f0
   - Запускается по расписанию или вручную
   - Делает то же самое, что и archive-monthly-reports

3. **monthly-reports** (чтение)
   - URL: проверьте в `func2url.json`
   - Используется для получения архивных данных
   - Параметры: `apartment_id`, `month`

## FAQ

**Q: Что если я запущу архивацию дважды за один месяц?**
A: Ничего страшного! Функция проверяет существование архива и не создаёт дубликаты.

**Q: Можно ли удалить архив?**
A: Да, но только через прямой SQL-запрос к базе данных. Будьте осторожны!

**Q: Как часто нужно архивировать?**
A: Рекомендуется делать это в начале каждого месяца (1-5 число).

**Q: Что показывается собственникам?**
A: Только те бронирования, где поле `showToGuest = true`.

**Q: Где хранятся текущие бронирования?**
A: В таблице `bookings`. Архив это отдельная таблица `monthly_reports`.
